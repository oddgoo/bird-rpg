{% extends 'base.html' %}

{% block title %}{{ nest.name }} | bird-rpg Village{% endblock %}

{% block content %}
<h2 class="text-center text-4xl text-yellow-900 mb-8 font-mystical font-bold">🏠 {{ nest.name }}</h2>

<div class="rounded-xl p-6 mb-8 shadow-lg border-4 border-yellow-900" style="background-image: url('/static/images/papyrus.jpg'); background-repeat: repeat;">
    <div class="border border-amber-300/50 rounded-lg p-4 bg-white/50">
        <div class="flex flex-wrap justify-center gap-4">
            <div class="inline-block bg-white px-5 py-2 rounded-full shadow-sm">
                <span>🪹 Twigs: {{ nest.twigs }}</span>
            </div>
            <div class="inline-block bg-white px-5 py-2 rounded-full shadow-sm">
                <span>🌰 Seeds: {{ nest.seeds }}</span>
            </div>
            <div class="inline-block bg-white px-5 py-2 rounded-full shadow-sm">
                <span>🎵 Songs Given: {{ nest.songs_given }}</span>
            </div>
            <div class="inline-block bg-white px-5 py-2 rounded-full shadow-sm">
                {% if nest.egg %}
                <span>🥚 Egg Progress: {{ nest.egg.brooding_progress }}/10</span>
                {% else %}
                <span>🥚 No Egg</span>
                {% endif %}
            </div>
            <div class="inline-block bg-white px-5 py-2 rounded-full shadow-sm">
                <span>🌱 Garden Size: {{ nest.garden_size }}</span>
            </div>
            <div class="inline-block bg-white px-5 py-2 rounded-full shadow-sm">
                <span>🌿 Garden Life: {{ nest.garden_life|default(0) }}</span>
            </div>
            <div class="inline-block bg-white px-5 py-2 rounded-full shadow-sm">
                <span>💡 Inspiration: {{ nest.inspiration|default(0) }}</span>
            </div>
        </div>
    </div>
</div>

<div class="rounded-xl p-6 mb-8 shadow-lg border-4 border-yellow-900" style="background-image: url('/static/images/papyrus.jpg'); background-repeat: repeat;">
    <div class="border border-amber-300/50 rounded-lg p-4">
        <h2 class="text-2xl text-center text-yellow-900 mb-4 font-mystical font-bold">🐣 Hatched Chicks</h2>
        {% if nest.chicks %}
        <ul class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            {% for chick in nest.chicks %}
            <li class="bg-white rounded-xl p-4 shadow-md flex flex-col items-center transition-transform transform hover:-translate-y-1 cursor-pointer relative overflow-hidden aspect-[5/7]">
                <a href="#" class="flex flex-col items-center no-underline w-full h-full" target="_blank" id="chick-link-{{ loop.index }}">
                    <img 
                        class="w-4/5 h-3/5 rounded-lg object-cover mb-4 transition-transform duration-200"
                        id="bird-{{ loop.index }}"
                        src="https://via.placeholder.com/100?text=🐦"
                        alt="{{ chick.commonName }}"
                    >
                    <div class="text-center">
                        <div class="text-lg font-bold text-orange-700">{{ chick.commonName }}</div>
                        <div class="italic text-gray-600 text-sm">{{ chick.scientificName }}</div>
                        <div class="mt-2 uppercase tracking-wide font-medium 
                            {% if chick.rarity == 'mythical' %}
                                text-yellow-700
                            {% elif chick.rarity == 'rare' %}
                                text-purple-600
                            {% elif chick.rarity == 'uncommon' %}
                                text-blue-500
                            {% else %}
                                text-green-500
                            {% endif %}">
                            ✧ {{ chick.rarity|title }} ✧
                        </div>
                        {% if chick.effect %}
                        <div class="mt-2 italic text-gray-600 text-xs px-2">
                            "{{ chick.effect }}"
                        </div>
                        {% endif %}
                    </div>
                </a>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-center">This nest hasn't hatched any chicks yet! 🐣</p>
        {% endif %}
    </div>
</div>

<div class="rounded-xl p-6 mb-8 shadow-lg border-4 border-yellow-900" style="background-image: url('/static/images/papyrus.jpg'); background-repeat: repeat;">
    <div class="border border-amber-300/50 rounded-lg p-4">
        <h2 class="text-2xl text-center text-yellow-900 mb-4 font-mystical font-bold">🎵 Today's Songs</h2>
        {% if nest.songs_given_to %}
        <div class="flex flex-wrap justify-center gap-4">
            {% for recipient_nest in nest.songs_given_to %}
            <div class="bg-white px-5 py-2 rounded-full shadow-sm transition-transform transform hover:-translate-y-0.5">
                <a href="/user/{{ recipient_nest.user_id }}" class="no-underline text-orange-700">
                    🎵 {{ recipient_nest.name }}
                </a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-center">No songs given today! 🎵</p>
        {% endif %}
    </div>
</div>

<div class="rounded-xl p-6 mb-8 shadow-lg border-4 border-yellow-900" style="background-image: url('/static/images/papyrus.jpg'); background-repeat: repeat;">
    <div class="border border-amber-300/50 rounded-lg p-4">
        <h2 class="text-2xl text-center text-yellow-900 mb-4 font-mystical font-bold">🥚 Today's Brooding</h2>
        {% if nest.brooded_nests %}
        <div class="flex flex-wrap justify-center gap-4">
            {% for brooded_nest in nest.brooded_nests %}
            <div class="bg-white px-5 py-2 rounded-full shadow-sm transition-transform transform hover:-translate-y-0.5">
                <a href="/user/{{ brooded_nest.user_id }}" class="no-underline text-orange-700">
                    🥚 {{ brooded_nest.name }}
                </a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-center">No eggs brooded today! 🥚</p>
        {% endif %}
    </div>
</div>

<div class="text-center mt-4">
    <a href="/" class="text-orange-700 hover:underline font-bold text-white">← Back</a>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% for chick in nest.chicks %}
        fetch(`https://api.inaturalist.org/v1/taxa?q={{ chick.scientificName }}&limit=1`)
            .then(response => response.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    const taxon = data.results[0];
                    if (taxon.default_photo) {
                        const imageUrl = taxon.default_photo.medium_url;
                        document.getElementById('bird-{{ loop.index }}').src = imageUrl;
                    }
                    const taxonUrl = `https://www.inaturalist.org/taxa/${taxon.id}`;
                    document.getElementById('chick-link-{{ loop.index }}').href = taxonUrl;
                } else {
                    console.warn(`No results found for {{ chick.scientificName }}`);
                    document.getElementById('chick-link-{{ loop.index }}').removeAttribute('href');
                    document.getElementById('chick-link-{{ loop.index }}').style.cursor = 'default';
                }
            })
            .catch(error => console.error('Error fetching bird image from iNaturalist:', error));
        {% endfor %}
    });
</script>
{% endblock %} 